# v1.0.0 운영 런북

## 범위
- 단일 프로세스 C++17 서버(v1.0.0)의 모니터링/문제 확인을 위한 최소 가이드.
- 외부 계약: `design/protocol/contract.md` 준수. 모든 상태는 메모리에 존재한다.

## 기동/종료
- 수동 실행: `./build/server_app` (필요 시 `SERVER_PORT`, `LOG_LEVEL` 등 환경 변수 지정).
- Docker Compose: `cd infra && docker compose up --build` / `docker compose down -v`.
- 종료 시 프로세스가 모든 연결을 닫으며 상태는 메모리라 복구되지 않는다.

## 로그
- stdout/stderr에 spdlog 형식으로 출력.
- 기본 필드: `traceId`, `path`(HTTP), `userId`/`sessionId`(가능 시), 지연(ms).
- 문제 재현 시: `LOG_LEVEL=debug`로 재기동하여 입력/큐/세션 이벤트를 세밀히 확인.

## 메트릭/상태 확인
- `/metrics` (비인증):
  - `requests.total`, `requests.errors`, `connections.websocket`, `sessions.active`, `queue.length` 필드 확인.
  - 에러 급증 시 계약/로그와照합해 원인을 좁힌다.
- `/ops/status` (헤더 `X-Ops-Token` 필요):
  - `activeSessions`, `queueLength`, `activeWebsocket`, `errorCount`를 한 번에 조회.
- 헬스 체크: `GET /api/health` → `version = v1.0.0` 확인.

## 자주 보는 시나리오
- 인증 실패 다발: `/api/auth/login` 401 증가 시 레이트리밋 설정(`LOGIN_RATE_LIMIT_*`)과 잘못된 토큰 사용 여부 확인.
- 큐 정체/중복: `/api/queue/join` 409(`queue_duplicate`) 발생 시 이미 큐/세션에 있는 사용자 여부를 로그/메트릭으로 확인 후 필요 시 `/api/queue/cancel` 호출.
- 세션 종료 후 입력: `session_not_found` 오류가 반복되면 클라이언트가 오래된 세션 ID를 사용 중이므로 재로그인/재입장을 안내한다.
- 백프레셔 종료: WS가 `1008 policy_violation`으로 닫히면 `WS_QUEUE_LIMIT_*` 값을 점검하거나 클라이언트 송신 속도를 낮춘다.

## 장애 대응 체크리스트
1. 헬스 체크 → 메트릭/ops 조회로 프로세스 상태 파악.
2. 로그에서 traceId 기준으로 문제 요청을 추적.
3. 큐/세션 수가 비정상적으로 높으면 프로세스 재시작(데이터 초기화) 전 사용자에게 영향 범위를 공지.
4. 필요 시 `LOGIN_RATE_LIMIT_MAX`, `MATCH_QUEUE_TIMEOUT_SECONDS`, `SESSION_TICK_INTERVAL_MS` 등을 일시 조정해 부하를 완화한다.

## 알려진 제한
- DB/Redis/Prometheus 미연동으로 인해 재시작 시 모든 상태가 초기화되고 외부 모니터링이 제한적이다.
- `/ops/status`는 단일 토큰 검증만 제공하며 세분화된 권한/감사 기능이 없다.
