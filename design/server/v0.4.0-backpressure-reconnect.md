# v0.4.0 백프레셔 및 재연결/리싱크 정책

## 목표
- 느린 소비자 클라이언트로 인해 서버 메모리/큐가 무한 증가하지 않도록 송신 큐 상한과 종료 정책을 고정한다.
- 재연결 이후에도 최소한의 상태 스냅샷을 재전달하는 리싱크 흐름을 마련한다.
- v0.5.0 이후 실제 세션 상태에 연결할 수 있도록 토큰/스냅샷 단계를 추상화한다.

## 송신 큐/백프레셔 정책
- 연결별 송신 큐는 **메시지 수**와 **총 바이트** 두 축 모두를 감시한다.
- 기본 상한(환경변수로 조정 가능):
  - `WS_QUEUE_LIMIT_MESSAGES`: 8 (테스트용 픽스처도 동일)
  - `WS_QUEUE_LIMIT_BYTES`: 65536 바이트 (테스트용 픽스처에서는 256 바이트)
- 상한 초과 시 정책: **연결 종료(B)**
  - 더 이상 큐에 쌓지 않고 즉시 close frame 송신 후 종료를 시도한다.
  - close code: `policy_violation(1008)`, reason: `backpressure_exceeded` 고정.
  - 종료 이후 추가 읽기/쓰기 작업은 중단한다.

## 재연결/리싱크 정책
- 식별 수단: `resumeToken`
  - WebSocket 업그레이드 성공 시 `auth_state` 이벤트에 `resumeToken`과 `snapshotVersion`을 포함한다.
  - 토큰은 사용자별로 발급/저장되며, 리싱크 성공 시 새 토큰으로 교체된다(회수 + 재발급).
- 리싱크 요청/응답 흐름
  1. 클라이언트가 이전 연결에서 받은 `resumeToken`을 `resync_request` 이벤트로 전송한다.
  2. 서버는 토큰이 해당 사용자에게 유효한지 검증한다.
     - 유효하지 않으면 `invalid_resume_token` 오류 이벤트를 보내고 연결은 유지한다.
  3. 유효하면 최신 스냅샷과 새 `resumeToken`을 담은 `resync_state` 이벤트를 내려준다.
- 스냅샷 내용(v0.4.0):
  - `version`: 1
  - `state`: `auth_only` (실제 세션 상태가 없음을 명시)
  - `issuedAt`: ISO8601 UTC 타임스탬프
  - `user`: `{userId, username}`
- 향후 확장 포인트: `snapshot` 필드를 세션 상태 구조체로 교체/확장하고 토큰을 실제 세션 ID/재연결 키와 연동.

## 테스트 커버리지
- **Slow consumer 종료 테스트**: 큐 상한 8개/256바이트에서 300바이트 메시지를 강제로 보내 송신 큐 바이트 제한 초과 시 `websocket::error::closed`로 연결이 닫히는지 검증.
- **재연결 리싱크 테스트**: 첫 연결에서 받은 `resumeToken`으로 두 번째 연결에서 `resync_state` 스냅샷과 새 토큰을 받는 흐름 확인.

## 관련 문서
- 계약: `design/protocol/contract.md`
- 구현: `server/include/server/websocket_session.hpp`, `server/src/websocket_session.cpp`, `server/include/server/reconnect.hpp`
- 테스트: `server/tests/e2e/reconnect_backpressure_test.cpp`, `server/tests/e2e/auth_flow_test.cpp`
