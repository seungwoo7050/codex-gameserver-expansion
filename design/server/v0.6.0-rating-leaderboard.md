# v0.6.0 레이팅/리더보드/정합성 규칙

## 목표
- 레이팅을 단일 Elo 방식(K=32)으로 고정하고 참가자 승패에 따라 갱신한다.
- 동일한 세션 결과가 중복 처리되더라도 저장과 레이팅 반영이 1회만 수행되도록 보장한다.
- 리더보드 조회 API를 페이지 단위로 제공하고 정렬/제한 규칙을 명시한다.

## 레이팅 계산
- 초기값: 모든 신규 사용자는 1000점에서 시작한다.
- 공식: `R' = R + K * (S - E)` (K=32, S는 실제 점수 1/0, E는 기대 승률).
- 기대 승률: `E = 1 / (1 + 10 ^ ((opponent - self)/400))`.
- 반올림: 계산 결과는 소수 첫째 자리에서 반올림하여 정수로 저장한다.
- 기록 필드: `rating`, `wins`, `losses`, `matches(=wins+losses)`.
- 정렬 기준: rating 내림차순 → userId 오름차순.

## 결과 정합성 및 트랜잭션 경계
- ResultRepository는 `session_id`를 키로 단일 저장만 허용한다.
- ResultService가 결과 저장(`SaveIfAbsent`) 성공 시에만 레이팅을 갱신한다.
- 동일 `session_id`로 FinalizeResult가 재호출되면 저장/레이팅 모두 재실행되지 않는다.
- 세션 종료 흐름에서 ResultService를 사용해 저장과 레이팅 반영을 묶어 idempotent하게 처리한다.

## 리더보드 API 규칙
- 경로: `GET /api/leaderboard` (공개, 인증 불필요).
- 쿼리: `page`(기본 1, 1 이상), `size`(기본 10, 1~50 허용).
- 에러: 범위를 벗어나면 `leaderboard_range` 코드와 HTTP 400을 반환한다.
- 응답 필드: `page`, `size`, `total`, `entries[{rank,userId,username,rating,wins,losses,matches}]`.
- 순위 계산: `rank = (page-1)*size + index + 1`.

## 프로필 확장
- `/api/profile` 응답에 사용자 레이팅 요약(`rating`, `wins`, `losses`, `matches`)을 포함한다.

## 테스트 포인트
- 단위: 동일 초기 레이팅 두 사용자 승패 시 1016/984로 계산되는지 확인.
- 통합:
  - 세션 종료 후 동일 결과를 다시 FinalizeResult해도 레이팅 값이 변하지 않는다.
  - `/api/leaderboard`가 페이지/사이즈 유효성 검사와 정렬을 준수한다.
