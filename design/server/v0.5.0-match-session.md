# v0.5.0 매칭/세션/결과 저장 경계

## 개요
- 대상 버전: v0.5.0
- 기능: Redis 기반 큐를 통한 2인 매칭, 세션 생성/시작/상태/종료 이벤트 브로드캐스트, 결과의 idempotent 저장.
- 외부 계약: `design/protocol/contract.md` 참조 (REST 큐 엔드포인트, WS 세션 이벤트, 오류 코드).

## 매칭 큐 경계
- 구현: `server/include/server/match_queue.hpp`, `server/src/match_queue.cpp`
- 역할: `/api/queue/join` 요청 시 사용자 정보를 대기열에 추가하고, 두 명이 모이면 즉시 페어링.
- 타임아웃: `MATCH_QUEUE_TIMEOUT_SECONDS` 기본 10초. 만료 시 큐에서 제거하고 해당 사용자에게 `queue_timeout` WS 오류 전송.
- 취소: `/api/queue/cancel` 호출 시 엔트리가 제거되며 큐에 없으면 `queue_not_found` 오류.
- 중복 방지: 이미 큐에 있거나 세션에 참여 중이면 `queue_duplicate`로 거부.
- 동기화: Redis 리스트를 가정하고 있으나 로컬 테스트에서는 메모리 큐를 사용하여 계약된 동작(순서/타임아웃/에러 코드)을 보장.

## 세션 경계
- 구현: `server/include/server/session_manager.hpp`, `server/src/session_manager.cpp`
- 생성: 매칭 시 `session-<번호>` 형태 ID 부여, 참가자 2명 정보와 함께 생성.
- 실행 컨텍스트: `boost::asio::strand`를 사용해 단일 실행 컨텍스트에서 틱, 입력, 종료를 직렬화.
- 틱 정책: `SESSION_TICK_INTERVAL_MS` (기본 100ms) 간격으로 진행, 기본 최대 5틱 후 `session.ended` 전송.
- 입력: `session.input` 이벤트로 전달, 시퀀스/틱/범위 검증 실패 시 `input_invalid` 오류.
- 상태 브로드캐스트: `session.started` 이후 각 틱마다 `session.state` 전달, 마지막에 `session.ended`와 승자/틱 수 포함.
- 이벤트 송신: `RealtimeCoordinator`를 통해 사용자별 WS 연결에 push하며 백프레셔 한도를 재사용.

## 결과 저장 경계
- 구현: `server/include/server/result_repository.hpp`, `server/src/result_repository.cpp`
- 저장 정책: `session_id` 고유 키로 idempotent 저장 (`SaveIfAbsent`), 중복 호출 시 무시.
- 스키마: `session_id`, `user1_id`, `user2_id`, `winner_user_id`, `tick_count`, `ended_at`, `snapshot_json`.
- 현재 상태: 로컬 테스트에서는 메모리 저장소를 사용하나, MariaDB upsert가 필요한 경우 동일 키 제약 조건을 적용하도록 설계.

## 연결/라우팅 경계
- `RealtimeCoordinator` (`server/include/server/realtime.hpp`)가 사용자 ID별 WS 세션을 보관하고 서버→클라이언트 이벤트/오류를 중계.
- WebSocket 수명: 연결 시 `auth_state` 후 coordinator에 등록, 종료 시 unregister.

## 테스트 경계
- 통합 테스트: `server/tests/e2e/session_flow_test.cpp`
  - 두 사용자 큐 참여 → 매칭 → 입력 전달 → `session.ended` 수신 → 결과 1건 저장 확인
  - 중복 큐 참가 거부 확인
  - 타임아웃 오류 이벤트 확인
- 기존 테스트: 인증/백프레셔/리싱크 시나리오와 병행 실행.

## 알려진 제약
- 현재 Redis/MariaDB는 로컬 테스트에서 모의로 동작하며, 실제 스토리지 연동 시에도 동일한 키/타임아웃 규칙을 유지해야 한다.
- `session.input`에 대한 ACK는 별도 응답 없이 오류만 전송한다.
