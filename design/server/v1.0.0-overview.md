# v1.0.0 서버 개요

## 목표
- 계약 문서와 구현/테스트를 일치시킨 안정화 릴리즈.
- 새 기능 추가 없이 인증·매칭·세션·레이팅 핵심 경로의 일관성과 관측 가능성을 강화한다.

## 프로세스/스레딩 구조
- 단일 프로세스, 단일 `boost::asio::io_context` 기반.
- I/O 워커 스레드 풀(기본 하드웨어 동시성)에 `io_context.run()`을 붙여 HTTP/WS 소켓을 비동기로 처리.
- 세션별 직렬화: `SessionManager`가 생성한 `SessionContext`마다 `strand`를 보유해 입력 처리와 틱 루프를 직렬화한다.
- 타이머: 세션 틱(`steady_timer`)과 매칭 대기 타임아웃을 비동기 타이머로 처리.
- DB/Redis는 현재 모의 수준이며 호출은 비차단 로직으로 감싸서 I/O 스레드를 점유하지 않는다.

## 주요 모듈
- `HttpSession`: HTTP 라우팅, 인증 헤더 추출, REST 엔벨로프 표준화, WS 업그레이드 진입점.
- `WebSocketSession`: 업그레이드 후 인증 상태 전파, `echo`/`resync_request`/`session.input` 처리, 백프레셔 초과 시 `1008` 종료.
- `AuthService`: 메모리 기반 사용자·세션 토큰 관리, 레이트리밋 적용, 토큰 TTL 검증.
- `MatchQueueService`: 사용자 큐 진입/취소/타임아웃 관리, 두 명씩 페어링 후 세션 생성.
- `SessionManager`: 세션 생성/시작/틱/종료, 입력 검증(`simulation.EnqueueInput`), 결과 생성·전달.
- `Simulation`: 단순 위치 갱신 시뮬레이션으로 결정적 결과를 만든다.
- `ResultService` + `ResultRepository`: 결과를 보관하고 idempotent하게 한 번만 확정 처리하며 레이팅 업데이트를 호출한다.
- `RatingService`: 메모리 기반 Elo 유사 업데이트, 리더보드 조회 제공.
- `ReconnectService`: `resumeToken` 발급/검증, `resync_state` 스냅샷 유지.
- `Observability`: 구조화 로그(traceId 포함)와 요청/에러/WS/세션/큐 카운터를 관리하고 /metrics, /ops/status에 제공한다.

## 데이터 저장/경계
- 모든 상태(사용자, 토큰, 큐, 세션, 결과, 레이팅, 메트릭)는 프로세스 메모리에만 존재한다.
- DB/Redis 접속 정보는 설정만 존재하며 실제 연동은 추후 버전 과제로 남겨 둔다.
- 결과/레이팅은 `ResultService::FinalizeResult` 한 번만 반영되도록 가드하며, 중복 호출 시 false를 반환한다.

## 핵심 플로우 요약
- 인증: register → login → 보호 API(access token) → logout. 실패 시 401 + `unauthorized`.
- 큐/매칭: `/api/queue/join` 성공 후 두 명이 들어오면 즉시 세션 생성, WS로 `session.created` → `session.started` → 주기적 `session.state` → `session.ended` 전송.
- 세션 입력: `session.input` 이벤트로만 받고 `strand`에서 검증. 종료 후 입력은 `session_not_found`로 거절.
- 결과/레이팅: 세션 종료 시 결과를 1회 저장하고 레이팅 업데이트 후 리더보드에 반영.
- 재연결: `/ws` 연결 시 `auth_state`로 재접속 토큰(`resumeToken`) 제공, `resync_request`로 스냅샷 재요청.
- 관측/운영: `/metrics`로 카운터 노출, `/ops/status`는 `X-Ops-Token` 비교로 보호.

## 알려진 한계(v1.0.0)
- 모든 데이터는 프로세스 재시작 시 소실된다.
- DB/Redis/Prometheus와의 실제 연동·영속화가 없다.
- 운영 토큰, 레이트리밋 파라미터 등은 환경 변수 기반의 단순 제어만 제공한다.
