# v0.2.0 인증/세션 설계

## 목표
- REST 회원가입/로그인/로그아웃 제공.
- 보호 엔드포인트(`/api/profile`)로 인증 강제 여부를 검증.
- WebSocket 업그레이드 시 사용자 토큰을 확인하고 연결을 사용자와 연동.
- 로그인 시도 레이트리밋과 토큰 만료 정책을 고정.

## 인증 모델
- 토큰 전달: HTTP/WS 모두 `Authorization: Bearer <token>` 헤더 단일 방식.
- 토큰 수명: 발급 시점 기준 1시간(`AUTH_TOKEN_TTL_SECONDS`) 후 만료.
- 로그아웃: 전달된 토큰을 즉시 폐기.
- 저장소: v0.2.0에서는 서버 프로세스 메모리에 사용자/세션을 저장한다(향후 버전에서 MariaDB/Redis로 이전 예정).

## 비밀번호 해시
- 알고리즘: PBKDF2-HMAC-SHA256 (OpenSSL), 반복 100,000회, 솔트 16바이트 랜덤.
- 저장 형식: 솔트/해시를 hex 문자열로 보관.
- 검증: `CRYPTO_memcmp`로 상수 시간 비교.

## 로그인 레이트리밋
- 단위: 클라이언트 IP 기준.
- 윈도우: 60초(`LOGIN_RATE_LIMIT_WINDOW`).
- 허용 횟수: 윈도우당 5회(`LOGIN_RATE_LIMIT_MAX`).
- 초과 시 HTTP 429 + `rate_limited` 코드 반환.

## 보호 엔드포인트
- `/api/profile`는 유효한 토큰이 없으면 HTTP 401 + `unauthorized`.
- 토큰이 유효하면 `{userId, username}` 정보를 반환.

## WebSocket 인증
- 업그레이드 요청에 `Authorization: Bearer <token>` 필요.
- 실패 시 HTTP 401 + REST 오류 엔벨로프를 응답하고 업그레이드 거부.
- 성공 시 즉시 `auth_state` 이벤트를 내려 사용자 식별 정보를 노출.
- `echo` 이벤트 응답 payload에 `userId`를 포함해 연결이 사용자와 연동됐음을 증명.

## 데이터 구조
- `AuthService`: 사용자 등록, 로그인, 토큰 검증/폐기, 만료 청소 수행.
- `RateLimiter`: IP별 버킷을 관리해 로그인 시도를 제한.
- `AuthSession`: `{token, user, expires_at}` 구조로 세션 보관.

## 제한사항
- 사용자/세션이 프로세스 메모리에만 저장되어 서버 재기동 시 초기화된다.
- DB/Redis 연결은 v0.2.0에서 사용하지 않는다(추후 버전에서 영속화 예정).
